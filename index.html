<!DOCTYPE html>

<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="GuidaTV - La tua guida completa ai programmi TV italiani con streaming online. Scopri cosa c'è in onda ora e stasera.">
    <meta name="keywords" content="guida tv, programmi tv, streaming tv italia, palinsesto tv, tv online, canali tv italiani">
    <meta name="author" content="emax83dev">
    <meta name="theme-color" content="#0a0e27">

```
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:title" content="GuidaTV - Guida TV Completa">
<meta property="og:description" content="La tua guida completa ai programmi TV italiani con streaming online">
<meta property="og:image" content="/img/og-image.jpg">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="GuidaTV - Guida TV Completa">
<meta name="twitter:description" content="La tua guida completa ai programmi TV italiani con streaming online">
<meta name="twitter:image" content="/img/twitter-image.jpg">

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/img/apple-touch-icon.png">

<title>GuidaTV - Guida TV Completa</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
    :root {
        --primary-color: #0dcaf0;
        --secondary-color: #0d6efd;
        --dark-bg: #0a0e27;
        --card-bg: #1a1f3a;
        --hover-bg: #252b4a;
        --text-primary: #ffffff;
        --text-secondary: #b0b8c8;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    html {
        background: var(--dark-bg);
        overscroll-behavior: none;
    }
    
    body {
        background: linear-gradient(135deg, var(--dark-bg) 0%, #0f1429 100%);
        color: var(--text-primary);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        padding-top: 70px;
        overscroll-behavior-y: none;
        -webkit-overflow-scrolling: touch;
    }
    
    .toolbar {
        background: linear-gradient(135deg, rgba(26, 31, 58, 0.95) 0%, rgba(15, 20, 41, 0.95) 100%);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid var(--primary-color);
        box-shadow: 0 4px 20px rgba(13, 202, 240, 0.2);
    }
    
    .toolbar .btn {
        color: var(--text-secondary);
        border: none;
        transition: all 0.3s ease;
        background: transparent;
        padding: 8px 12px;
        border-radius: 8px;
    }
    
    .toolbar .btn:hover, .toolbar .btn.active {
        color: var(--primary-color);
        background: var(--hover-bg);
        transform: translateY(-2px);
    }
    
    .logo-text {
        font-size: 1.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .current-time {
        color: var(--primary-color);
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .channel-scroll {
        display: flex;
        overflow-x: auto;
        gap: 15px;
        padding: 20px 0;
        scroll-behavior: smooth;
    }
    
    .channel-scroll::-webkit-scrollbar {
        height: 8px;
    }
    
    .channel-scroll::-webkit-scrollbar-track {
        background: var(--card-bg);
        border-radius: 10px;
    }
    
    .channel-scroll::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }
    
    .channel-card {
        min-width: 140px;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .channel-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(13, 202, 240, 0.3);
    }
    
    .channel-logo {
        width: 80px;
        height: 80px;
        object-fit: contain;
        margin: 0 auto;
        display: block;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 5px;
    }
    
    .channel-name {
        text-align: center;
        margin-top: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .channels-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        padding: 20px 0;
    }
    
    .channel-grid-item {
        aspect-ratio: 1;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .channel-grid-item:hover {
        border-color: var(--primary-color);
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(13, 202, 240, 0.3);
    }
    
    .modal-content {
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--dark-bg) 100%);
        border: 2px solid var(--primary-color);
        border-radius: 20px;
    }
    
    .modal-header {
        border-bottom: 2px solid var(--primary-color);
    }
    
    .bottom-sheet {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 80vh;
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--dark-bg) 100%);
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
        border: 2px solid var(--primary-color);
        border-bottom: none;
        transform: translateY(100%);
        transition: transform 0.4s ease;
        z-index: 1050;
        overflow-y: auto;
        box-shadow: 0 -10px 40px rgba(13, 202, 240, 0.3);
    }
    
    .bottom-sheet.show {
        transform: translateY(0);
    }
    
    .bottom-sheet-handle {
        width: 50px;
        height: 5px;
        background: var(--text-secondary);
        border-radius: 10px;
        margin: 15px auto;
    }
    
    .program-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .program-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 5px 20px rgba(13, 202, 240, 0.2);
    }
    
    .program-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    
    .program-title {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
    
    .program-time {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .program-genre {
        display: inline-block;
        background: var(--primary-color);
        color: var(--dark-bg);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .progress-bar {
        background: var(--primary-color);
        transition: width 0.3s ease;
    }
    
    .evening-programs {
        display: flex;
        overflow-x: auto;
        gap: 15px;
        padding: 10px 0;
        scroll-behavior: smooth;
    }
    
    .evening-program-card {
        min-width: 250px;
        background: var(--hover-bg);
        border-radius: 15px;
        padding: 15px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .evening-program-card:hover {
        border-color: var(--primary-color);
        transform: scale(1.05);
    }
    
    .favorite-btn {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .favorite-btn:hover {
        background: var(--primary-color);
        color: var(--dark-bg);
        transform: scale(1.1);
    }
    
    .favorite-btn.active {
        background: var(--primary-color);
        color: var(--dark-bg);
    }
    
    .favorite-card {
        min-width: 160px;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid var(--primary-color);
        position: relative;
    }
    
    .favorite-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(13, 202, 240, 0.3);
    }
    
    .remove-favorite {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.8);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .remove-favorite:hover {
        background: rgba(220, 53, 69, 1);
        transform: scale(1.2);
    }
    
    .not-scheduled {
        color: var(--text-secondary);
        font-style: italic;
        font-size: 0.85rem;
    }
    
    #videoPlayer {
        width: 100%;
        border-radius: 10px;
        background: #000;
    }
    
    .search-input {
        background: var(--card-bg);
        border: 2px solid var(--primary-color);
        color: var(--text-primary);
        border-radius: 10px;
        padding: 12px 20px;
    }
    
    .search-input:focus {
        background: var(--card-bg);
        color: var(--text-primary);
        border-color: var(--primary-color);
        box-shadow: 0 0 20px rgba(13, 202, 240, 0.3);
    }
    
    .search-result {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .search-result:hover {
        border-color: var(--primary-color);
        transform: translateX(5px);
    }
    
    .spinner-border {
        color: var(--primary-color);
    }
    
    .section {
        display: none;
        animation: fadeIn 0.5s ease;
    }
    
    .section.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .bottom-sheet-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1040;
        display: none;
    }
    
    .bottom-sheet-backdrop.show {
        display: block;
    }
    
    .cookie-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, rgba(26, 31, 58, 0.98) 0%, rgba(15, 20, 41, 0.98) 100%);
        backdrop-filter: blur(10px);
        border-top: 2px solid var(--primary-color);
        padding: 20px;
        z-index: 9999;
        box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.5);
        transform: translateY(100%);
        transition: transform 0.4s ease;
    }
    
    .cookie-banner.show {
        transform: translateY(0);
    }
    
    .cookie-banner-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .cookie-banner-text {
        flex: 1;
        min-width: 250px;
    }
    
    .cookie-banner-text h5 {
        color: var(--primary-color);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    .cookie-banner-text p {
        color: var(--text-secondary);
        margin: 0;
        font-size: 0.9rem;
    }
    
    .cookie-banner .btn-simple-ok {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border: none;
        color: white;
        padding: 12px 40px;
    }
    
    .cookie-banner .btn-simple-ok:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(13, 202, 240, 0.4);
    }
    
    .modal {
        z-index: 1055;
    }
    
    .modal-backdrop {
        z-index: 1050;
    }
    
    #playerModal {
        z-index: 1070;
    }
    
    @media (max-width: 768px) {
        .cookie-banner-content {
            flex-direction: column;
            text-align: center;
        }
    }
</style>


</head>
<body>
    <div id="app">
        <!-- Toolbar -->
        <nav class="navbar navbar-expand toolbar fixed-top">
            <div class="container-fluid">
                <span class="navbar-brand logo-text mb-0 h1">
                    <i class="bi bi-tv"></i> <span class="d-none d-md-inline">GuidaTV</span>
                </span>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button class="btn btn-primary mt-3 w-100" @click="playChannel(selectedChannel)">
                        <i class="bi bi-play-fill"></i> Guarda in Streaming
                    </button>
                </div>
            </div>
        </div>

    <!-- Search Modal -->
    <div class="modal fade" :class="{ show: showSearchModal, 'd-block': showSearchModal }" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-search"></i> Cerca Programmi</h5>
                    <button type="button" class="btn-close btn-close-white" @click="showSearchModal = false"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control search-input mb-4" v-model="searchQuery" placeholder="Cerca canale o programma...">
                    <div v-if="searchQuery.length < 2">
                        <p class="text-muted">Inserisci almeno 2 caratteri per cercare</p>
                    </div>
                    <div v-else-if="searchResults.length === 0">
                        <p class="text-muted">Nessun risultato trovato</p>
                    </div>
                    <div v-else>
                        <div v-for="result in searchResults.slice(0, 20)" :key="result.key" class="search-result" @click="handleSearchResultClick(result)">
                            <div class="d-flex align-items-center">
                                <img :src="result.channel.logo" style="width: 50px; height: 50px; object-fit: contain; margin-right: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 5px;" @error="handleImageError">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ result.type === 'channel' ? result.channel.name : result.program.title }}</div>
                                    <small class="text-muted">
                                        <i class="bi bi-tv"></i> {{ result.channel.name }}
                                        <span v-if="result.type === 'program'"> • <i class="bi bi-clock"></i> {{ formatTime(utcToLocal(result.program.start)) }}</span>
                                        <span v-else> • Canale</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div v-if="showSearchModal" class="modal-backdrop fade show"></div>

    <!-- Channel Schedule Modal -->
    <div class="modal fade" :class="{ show: showScheduleModal, 'd-block': showScheduleModal }" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ selectedChannel?.name }} - Programmazione</h5>
                    <button type="button" class="btn-close btn-close-white" @click="showScheduleModal = false"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div v-if="selectedChannel">
                        <div class="text-center mb-4">
                            <img :src="selectedChannel.logo" :alt="selectedChannel.name" style="width: 80px;" @error="handleImageError">
                            <button class="btn btn-primary mt-3" @click="playChannel(selectedChannel)">
                                <i class="bi bi-play-fill"></i> Guarda in Streaming
                            </button>
                        </div>
                        <div v-for="program in getTodayPrograms(selectedChannel)" :key="program.start" class="program-card" :class="{ 'border-primary': isCurrentProgram(selectedChannel, program) }">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="program-title" style="font-size: 1.1rem;">{{ program.title }}</h5>
                                    <div class="program-time">
                                        <i class="bi bi-clock"></i> {{ formatTime(utcToLocal(program.start)) }} • {{ getDuration(program) }}
                                    </div>
                                </div>
                                <span v-if="isCurrentProgram(selectedChannel, program)" class="badge bg-danger">IN ONDA</span>
                            </div>
                            <span v-if="program.category" class="program-genre">{{ program.category }}</span>
                            <p v-if="program.description" class="mt-2 mb-0 small">{{ program.description }}</p>
                            <button v-if="isCurrentProgram(selectedChannel, program)" class="btn btn-sm btn-primary mt-3" @click="playChannel(selectedChannel)">
                                <i class="bi bi-play-fill"></i> Guarda Ora
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div v-if="showScheduleModal" class="modal-backdrop fade show"></div>

    <!-- Program Detail Modal -->
    <div class="modal fade" :class="{ show: showProgramDetailModal, 'd-block': showProgramDetailModal }" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ selectedProgram?.title }}</h5>
                    <button type="button" class="btn-close btn-close-white" @click="showProgramDetailModal = false"></button>
                </div>
                <div class="modal-body">
                    <div v-if="selectedChannel && selectedProgram">
                        <div class="text-center mb-3">
                            <img :src="selectedChannel.logo" :alt="selectedChannel.name" style="width: 80px;" @error="handleImageError">
                            <h5 class="mt-2">{{ selectedChannel.name }}</h5>
                        </div>
                        
                        <div class="program-card">
                            <img v-if="selectedProgram.image" :src="selectedProgram.image" class="program-image" @error="$event.target.style.display='none'">
                            
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h3 class="program-title">{{ selectedProgram.title }}</h3>
                                <button class="favorite-btn" :class="{ active: isFavoriteProgram(selectedChannel, selectedProgram) }" @click="toggleFavoriteProgram(selectedChannel, selectedProgram)" title="Aggiungi programma ai preferiti">
                                    <i class="bi bi-star"></i>
                                </button>
                            </div>
                            
                            <div class="program-time mb-2">
                                <i class="bi bi-clock"></i> {{ formatTime(utcToLocal(selectedProgram.start)) }} • {{ getDuration(selectedProgram) }}
                                <span v-if="isProgramLive(selectedProgram)" class="badge bg-danger ms-2">IN ONDA ORA</span>
                            </div>
                            
                            <span v-if="selectedProgram.category" class="program-genre">{{ selectedProgram.category }}</span>
                            <p v-if="selectedProgram.description" class="mt-3">{{ selectedProgram.description }}</p>
                            
                            <div v-if="isProgramLive(selectedProgram)" class="mt-3">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" :style="{ width: calculateProgress(selectedProgram) + '%' }"></div>
                                </div>
                                <small class="text-muted">{{ Math.round(calculateProgress(selectedProgram)) }}% completato</small>
                            </div>
                            
                            <button v-if="isProgramLive(selectedProgram)" class="btn btn-primary mt-3 w-100" @click="playChannel(selectedChannel)">
                                <i class="bi bi-play-fill"></i> Guarda Ora in Streaming
                            </button>
                            <div v-else class="alert alert-info mt-3 mb-0">
                                <i class="bi bi-info-circle"></i> Questo programma non è attualmente in onda
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div v-if="showProgramDetailModal" class="modal-backdrop fade show"></div>

    <!-- Video Player Modal -->
    <div class="modal fade" :class="{ show: showPlayerModal, 'd-block': showPlayerModal }" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ playerChannelName }}</h5>
                    <button type="button" class="btn-close btn-close-white" @click="closePlayer"></button>
                </div>
                <div class="modal-body">
                    <video ref="videoPlayer" id="videoPlayer" controls></video>
                </div>
            </div>
        </div>
    </div>
    <div v-if="showPlayerModal" class="modal-backdrop fade show"></div>

    <!-- Cookie Banner -->
    <div class="cookie-banner" :class="{ show: showCookieBanner }">
        <div class="cookie-banner-content">
            <div class="cookie-banner-text">
                <h5><i class="bi bi-shield-check"></i> Privacy & Cookie</h5>
                <p>
                    Questo sito <strong>non utilizza cookie di tracciamento</strong> e <strong>non memorizza informazioni personali</strong>. 
                    Utilizziamo solo il localStorage del browser per salvare le tue preferenze locali (come i canali preferiti).
                </p>
            </div>
            <div class="cookie-banner-actions">
                <button class="btn btn-simple-ok" @click="acceptCookies">
                    <i class="bi bi-check-circle"></i> Ho capito
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- Vue.js 3 -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                channels: [],
                loading: true,
                error: null,
                currentSection: 'favorites',
                currentTime: '',
                favorites: {
                    channels: [],
                    programs: []
                },
                selectedChannel: null,
                selectedProgram: null,
                showBottomSheet: false,
                bottomSheetContent: null,
                showSearchModal: false,
                showScheduleModal: false,
                showProgramDetailModal: false,
                showPlayerModal: false,
                searchQuery: '',
                showCookieBanner: false,
                playerChannelName: '',
                hls: null
            }
        },

        computed: {
            hasFavorites() {
                return this.favorites.channels.length > 0 || this.favorites.programs.length > 0;
            },

            favoriteChannels() {
                return this.channels.filter(channel => 
                    this.favorites.channels.some(fav => fav.name === channel.name)
                );
            },

            favoriteProgramsWithInfo() {
                return this.favorites.programs.map(favProg => {
                    const channel = this.channels.find(c => c.name === favProg.channelName);
                    if (!channel) return null;

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const todayProgram = channel.programs.find(p => {
                        const start = this.utcToLocal(p.start);
                        return p.title === favProg.title && start.toDateString() === today.toDateString();
                    });

                    return {
                        ...favProg,
                        key: `${favProg.channelName}:${favProg.title}`,
                        channel: channel,
                        todayProgram: todayProgram
                    };
                }).filter(Boolean);
            },

            channelsWithCurrentProgram() {
                return this.channels.filter(channel => this.getCurrentProgram(channel) !== null);
            },

            channelsWithEveningPrograms() {
                return this.channels.filter(channel => this.getEveningPrograms(channel).length > 0);
            },

            searchResults() {
                if (this.searchQuery.length < 2) return [];

                const results = [];
                const searchLower = this.searchQuery.toLowerCase();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                this.channels.forEach(channel => {
                    if (channel.name.toLowerCase().includes(searchLower)) {
                        results.push({
                            type: 'channel',
                            channel: channel,
                            key: `channel-${channel.id}`
                        });
                    }

                    channel.programs.forEach(program => {
                        if (program.title.toLowerCase().includes(searchLower)) {
                            const start = this.utcToLocal(program.start);
                            if (start.toDateString() === today.toDateString()) {
                                results.push({
                                    type: 'program',
                                    channel: channel,
                                    program: program,
                                    key: `program-${channel.id}-${program.start}`
                                });
                            }
                        }
                    });
                });

                return results;
            }
        },

        methods: {
            async loadData() {
                this.loading = true;
                this.error = null;

                try {
                    const originalUrl = 'https://www.emax83dev.it/api/epg';
                    
                    let response;
                    try {
                        response = await fetch(originalUrl);
                        if (!response.ok) throw new Error('Direct fetch failed');
                    } catch (directError) {
                        const corsProxies = [
                            `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`,
                            `https://corsproxy.io/?${encodeURIComponent(originalUrl)}`
                        ];
                        
                        for (const proxyUrl of corsProxies) {
                            try {
                                response = await fetch(proxyUrl);
                                if (response.ok) break;
                            } catch (e) {
                                console.log('Proxy failed:', e);
                            }
                        }
                    }

                    if (!response || !response.ok) {
                        throw new Error('Impossibile caricare i dati');
                    }

                    const jsonData = await response.json();
                    
                    this.channels = jsonData.map(item => ({
                        id: item.id,
                        name: item.name,
                        epgName: item.epgName,
                        logo: item.logo,
                        playlist: item.m3uLink,
                        programs: item.programs.map(program => ({
                            start: program.start,
                            stop: program.end,
                            title: program.title,
                            description: program.description,
                            category: program.category,
                            image: program.poster
                        }))
                    }));

                    this.loading = false;
                    this.autoOpenFirstChannel();

                } catch (error) {
                    console.error('Error loading data:', error);
                    this.error = error.message;
                    this.loading = false;
                }
            },

            utcToLocal(utcDateStr) {
                const date = new Date(utcDateStr);
                return new Date(date.toLocaleString('en-US', { timeZone: 'Europe/Rome' }));
            },

            formatTime(date) {
                return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            },

            updateCurrentTime() {
                const now = new Date();
                this.currentTime = this.formatTime(now);
            },

            getCurrentProgram(channel) {
                const now = new Date();
                return channel.programs.find(program => {
                    const start = this.utcToLocal(program.start);
                    const end = this.utcToLocal(program.stop);
                    return now >= start && now < end;
                });
            },

            getEveningPrograms(channel) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return channel.programs.filter(program => {
                    const start = this.utcToLocal(program.start);
                    const hour = start.getHours();
                    const isSameDay = start.toDateString() === today.toDateString();
                    return isSameDay && hour >= 20 && hour < 23;
                });
            },

            getTodayPrograms(channel) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return channel.programs
                    .filter(program => {
                        const start = this.utcToLocal(program.start);
                        return start.toDateString() === today.toDateString();
                    })
                    .sort((a, b) => this.utcToLocal(a.start) - this.utcToLocal(b.start));
            },

            calculateProgress(program) {
                const now = new Date();
                const start = this.utcToLocal(program.start);
                const end = this.utcToLocal(program.stop);
                const total = end - start;
                const elapsed = now - start;
                return Math.min(100, Math.max(0, (elapsed / total) * 100));
            },

            getDuration(program) {
                const start = this.utcToLocal(program.start);
                const end = this.utcToLocal(program.stop);
                const minutes = Math.round((end - start) / 60000);
                return `${minutes} min`;
            },

            isCurrentProgram(channel, program) {
                const current = this.getCurrentProgram(channel);
                return current?.title === program.title;
            },

            isProgramLive(program) {
                const now = new Date();
                const start = this.utcToLocal(program.start);
                const end = this.utcToLocal(program.stop);
                return now >= start && now < end;
            },

            loadFavorites() {
                try {
                    const stored = localStorage.getItem('guidatv_favorites');
                    if (stored) {
                        this.favorites = JSON.parse(stored);
                    }
                } catch (e) {
                    console.error('Error loading favorites:', e);
                }
            },

            saveFavorites() {
                try {
                    localStorage.setItem('guidatv_favorites', JSON.stringify(this.favorites));
                } catch (e) {
                    console.error('Error saving favorites:', e);
                }
            },

            toggleFavoriteChannel(channel) {
                const index = this.favorites.channels.findIndex(c => c.name === channel.name);
                if (index > -1) {
                    this.favorites.channels.splice(index, 1);
                } else {
                    this.favorites.channels.push({
                        name: channel.name,
                        logo: channel.logo,
                        playlist: channel.playlist
                    });
                }
                this.saveFavorites();
            },

            toggleFavoriteProgram(channel, program) {
                const key = `${channel.name}:${program.title}`;
                const index = this.favorites.programs.findIndex(p => 
                    `${p.channelName}:${p.title}` === key
                );
                
                if (index > -1) {
                    this.favorites.programs.splice(index, 1);
                } else {
                    this.favorites.programs.push({
                        channelName: channel.name,
                        channelLogo: channel.logo,
                        title: program.title,
                        category: program.category
                    });
                }
                this.saveFavorites();
            },

            removeFavoriteProgram(prog) {
                const index = this.favorites.programs.findIndex(p => 
                    p.channelName === prog.channelName && p.title === prog.title
                );
                if (index > -1) {
                    this.favorites.programs.splice(index, 1);
                    this.saveFavorites();
                }
            },

            isFavoriteChannel(channel) {
                return this.favorites.channels.some(c => c.name === channel.name);
            },

            isFavoriteProgram(channel, program) {
                const key = `${channel.name}:${program.title}`;
                return this.favorites.programs.some(p => 
                    `${p.channelName}:${p.title}` === key
                );
            },

            showNowPlaying(channel) {
                const currentProgram = this.getCurrentProgram(channel);
                if (!currentProgram) return;

                this.selectedChannel = channel;
                this.selectedProgram = currentProgram;
                this.bottomSheetContent = 'now';
                this.showBottomSheet = true;
            },

            showEveningPrograms(channel) {
                this.selectedChannel = channel;
                this.bottomSheetContent = 'evening';
                this.showBottomSheet = true;
            },

            showChannelSchedule(channel) {
                this.selectedChannel = channel;
                this.showScheduleModal = true;
            },

            openChannelDetail(channel) {
                const currentProgram = this.getCurrentProgram(channel);
                if (currentProgram) {
                    this.showNowPlaying(channel);
                } else {
                    this.showChannelSchedule(channel);
                }
            },

            handleSearchResultClick(result) {
                this.showSearchModal = false;
                
                if (result.type === 'channel') {
                    this.showChannelSchedule(result.channel);
                } else {
                    this.selectedChannel = result.channel;
                    this.selectedProgram = result.program;
                    this.showProgramDetailModal = true;
                }
            },

            handleFavoriteProgramClick(prog) {
                if (prog.todayProgram) {
                    this.showChannelSchedule(prog.channel);
                } else {
                    alert(`"${prog.title}" non è programmato oggi su ${prog.channelName}`);
                }
            },

            playChannel(channel) {
                if (!channel.playlist) {
                    alert('Stream non disponibile per questo canale');
                    return;
                }

                this.playerChannelName = channel.name;
                this.showBottomSheet = false;
                this.showPlayerModal = true;

                this.$nextTick(() => {
                    const video = this.$refs.videoPlayer;
                    
                    if (Hls.isSupported()) {
                        if (this.hls) {
                            this.hls.destroy();
                        }
                        this.hls = new Hls();
                        this.hls.loadSource(channel.playlist);
                        this.hls.attachMedia(video);
                        this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            video.play();
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = channel.playlist;
                        video.addEventListener('loadedmetadata', () => {
                            video.play();
                        });
                    } else {
                        alert('Il tuo browser non supporta lo streaming HLS');
                    }
                });
            },

            closePlayer() {
                if (this.hls) {
                    this.hls.destroy();
                    this.hls = null;
                }
                this.showPlayerModal = false;
            },

            loadCookieConsent() {
                try {
                    const stored = localStorage.getItem('guidatv_cookie_consent');
                    if (!stored) {
                        setTimeout(() => {
                            this.showCookieBanner = true;
                        }, 1000);
                    }
                } catch (e) {
                    console.error('Error loading cookie consent:', e);
                }
            },

            acceptCookies() {
                try {
                    localStorage.setItem('guidatv_cookie_consent', JSON.stringify({
                        bannerVisible: false,
                        cookiesAccepted: false
                    }));
                    this.showCookieBanner = false;
                } catch (e) {
                    console.error('Error saving cookie consent:', e);
                }
            },

            handleImageError(event) {
                event.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%231a1f3a' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%230dcaf0' text-anchor='middle' dy='.3em'%3ETV%3C/text%3E%3C/svg%3E";
            },

            autoOpenFirstChannel() {
                if (this.hasFavorites) {
                    this.currentSection = 'favorites';
                } else {
                    this.currentSection = 'now';
                    setTimeout(() => {
                        const firstChannel = this.channelsWithCurrentProgram[0];
                        if (firstChannel) {
                            this.showNowPlaying(firstChannel);
                        }
                    }, 500);
                }
            }
        },

        mounted() {
            this.loadFavorites();
            this.loadCookieConsent();
            this.loadData();
            this.updateCurrentTime();
            setInterval(() => {
                this.updateCurrentTime();
            }, 1000);
        }
    }).mount('#app');
</script>

</body>
</html> 
